# 野火F103MINI板

## 安装各种芯片包，才能使用对应的芯片进行调试（KEIL5）

## DAP仿真器下载程序

### 仿真器配置

1、Debug的选配

2、Utilities的选配

3、Debug Settings的选配

### 选目标板

### 下载程序

Application running ...

## 串口下载程序（使用相对于的软件）

使用的是hex文件或者bin文件来进行烧录程序

## STM32

其中分为软件部分和硬件部分

软件部分使用的是keil5软件、VS2019、vcode等等，多学习c语言的编程知识，主要的是逻辑思维，多看不断积累，不断学习

硬件部分使用的是AD软件，来进行原理图的设计，分析电源部分，产生的各种问题，如出现辐射现象，要考虑节约成本，多方面考虑问题，不断积累，很吃经验。经验告诉自己固定这样做。并且进行PCB的布局之类的，建议看哔哩哔哩中的凡亿教育的课程，多学习AD软件的快捷键。

## 寄存器

### 芯片

芯片包括M3内核和外设连接构成

### 存储器映射

4GB的地址空间 = 8 * 512 MB = 8 * 512 * 1024 * 1024 Bytes = 4294967296 Bytes

4294967296（十进制）= 0x100000000（十六进制）地址范围：0x00000000~0xFFFFFFFF

平分为8个地址

536870912（十进制） = 0x20000000（十六进制）地址范围：0x00000000~0x1FFFFFFF

1个字节 = 1 Byte = 8 Bits

1 KB = 1024 Bytes（表示1024个地址，1024（十进制） = 0x400（十六进制）地址范围：0x00~0x3FF）

1 MB = 1024 KB

1 GB = 1024 MB

Block0主要用于设计片内的FLASH，0x08000000~0x0807FFFF(512KB)

Block1用于设计片内的SRAM，0x20000000~0x2000FFFF（64KB）

### 寄存器映射

1个单元 = 4个字节 = 32 bits

eg：

​	GPIOB端口输出数据寄存器ODR的地址是 0x40010C0C，ODR寄存器是32bit，低16bit有效，对应16个外部IO

```c
// GPIOB 端口全部输出 高电平
*(unsigned int*)(0x4001 0C0C) = 0xFFFF;
```

0x4001 0C0C 在我们看来是GPIOB 端口ODR 的地址，但是在编译器看来，这只是一个普通的变量，是一个立即数，要想让编译器也认为是指针，我们得进行强制类型转换，把它转换成指针，即(unsigned int *)0x4001 0C0C，然后再对这个指针进行 * 操作。

```c
// GPIOB 端口全部输出 高电平
#define GPIOB_ODR *(unsigned int*)(GPIOB_BASE+0x0C)
GPIOB_ODR = 0xFF;
```

#### STM32外设地址映射

片上外设分为三条总线，APB1挂载低速外设，APB2和AHB挂载高速外设。

##### 总线基地址

| 总线名称 | 总线基地址  | 相对外设基地址的偏移 |
| -------- | ----------- | -------------------- |
| APB1     | 0x4000 0000 | 0x0                  |
| APB2     | 0x4001 0000 | 0x0001 0000          |
| AHB      | 0x4001 8000 | 0x0001 8000          |

##### 外设基地址

GPIO这个外设属于高速的外设，挂载到APB2总线上。

| 外设名称 | 外设基地址  | 相对APB2总线的地址偏移 |
| -------- | ----------- | ---------------------- |
| GPIOA    | 0x4001 0800 | 0x0000 0800            |
| GPIOB    | 0x4001 0C00 | 0x0000 0C00            |
| GPIOC    | 0x4001 1000 | 0x0000 1000            |
| GPIOD    | 0x4001 1400 | 0x0000 1400            |
| GPIOE    | 0x4001 1800 | 0x0000 1800            |
| GPIOF    | 0x4001 1C00 | 0x0000 1C00            |
| GPIOG    | 0x4001 2000 | 0x0000 2000            |

##### 外设寄存器

| 寄存器名称 | 寄存器地址  | 相对GPIO基址的偏移 |
| ---------- | ----------- | ------------------ |
| GPIOB_CRL  | 0x4001 0C00 | 0x00               |
| GPIOB_CRH  | 0x4001 0C04 | 0x04               |
| GPIOB_IDR  | 0x4001 0C08 | 0x08               |
| GPIOB_ODR  | 0x4001 0C0C | 0x0C               |
| GPIOB_BSRR | 0x4001 0C10 | 0x10               |
| GPIOB_BRR  | 0x4001 0C14 | 0x14               |
| GPIOB_LCKR | 0x4001 0C18 | 0x18               |

每一个寄存器都有16个引脚，分为三种状态：w、r、w\r，并包括设置或者清除位。eg：BR0写入“1”代表第0引脚输出“低电平”，但是写入“0”不会影响0位，BS0写入“1”代表引脚输出“高电平”。

#### 修改寄存器的位操作

##### 将变量的某位清零

```c
//定义一个变量a = 1001 1111 b (二进制数)
unsigned char a = 0x9f;

//对bit2 清零

a &= ~(1<<2);

//括号中的1 左移两位，(1<<2)得二进制数：0000 0100 b
//按位取反，~(1<<2)得1111 1011 b
//假如a 中原来的值为二进制数： a = 1001 1111 b
//所得的数与a 作”位与&”运算，a = (1001 1111 b)&(1111 1011 b),
//经过运算后，a 的值 a=1001 1011 b
//a的bit2位被清零，而其他位不变。
```

##### 将变量的某几个连续位清零

```c
//若把a 中的二进制位分成2 个一组
//即bit0、bit1 为第0 组，bit2、bit3 为第1 组，
// bit4、bit5 为第2 组，bit6、bit7 为第3 组
//要对第1 组的bit2、bit3 清零

a &= ~(3<<2*1);

//括号中的3 左移两位，(3<<2*1)得二进制数：0000 1100 b
//按位取反，~(3<<2*1)得1111 0011 b
//假如a 中原来的值为二进制数： a = 1001 1111 b
//所得的数与a 作”位与&”运算，a = (1001 1111 b)&(1111 0011 b),
//经过运算后，a 的值 a=1001 0011 b
// a 的第1 组的bit2、bit3 被清零，而其它位不变。

//上述(~(3<<2*1))中的(1)即为组编号;如清零第3 组bit6、bit7 此处应为3
//括号中的(2)为每组的位数，每组有2 个二进制位;若分成4 个一组，此处即为4
//括号中的(3)是组内所有位都为1 时的值;若分成4 个一组，此处即为二进制数“1111 b”

//例如对第2 组bit4、bit5 清零
a &= ~(3<<2*2);
```

##### 将变量的某几位进行赋值

```c
//a = 1000 0011 b
//此时对清零后的第2 组bit4、bit5 设置成二进制数“01 b ”

a |= (1<<2*2);
//a = 1001 0011 b，成功设置了第2 组的值，其它组不变
```

##### 将变量的某位取反

```c
//a = 1001 0011 b
//把bit6 取反，其它位不变

a ^=(1<<6);
//a = 1101 0011 b
```

## 新建工程---寄存器版

### 新建工程

#### 新建本地工程文件夹

为了工程目录更加清晰，我们在本地电脑上新建1 个文件夹用于存放整个工程，如命名为“LED”，然后在该目录下新建2 个文件夹

| 名称                  | 作用                                                |
| --------------------- | --------------------------------------------------- |
| Listing               | 存放编译器编译时候产生的c/汇编/链接的列表清单       |
| Output（或者Objects） | 存放编译产生的调试信息、hex文件、预览信息、封装库等 |

| 名称                  | 作用                                                |
| --------------------- | --------------------------------------------------- |
| LED                   | 存放startup_stm32f10x_hd.s、stm32f10x.h、main.c文件 |
| Listing               | 暂时为空                                            |
| Output（或者Objects） | 暂时为空                                            |

#### 新建工程

打开KEIL5，新建---Project---New Project...

选择CPU型号

添加文件---startup_stm32f10x_hd.s、stm32f10x.h、main.c

配置魔术棒选项卡---47页

下载器配置

### 下载程序

点击LOAD按钮

## 寄存器点亮LED灯

### GPIO

GPIOA到FPIOE共5组，每组16个引脚，具有输入输出功能

输入功能是检测外部输入电平，通过电平高低区分按键是否被按下

输出功能是高低电平的输出切换，实现开关控制，来控制灯的亮灭

#### 基本结构

![1](https://github.com/Leon199601/MCU/blob/main/pic/w-1.jpg)

